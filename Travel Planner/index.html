<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Planner</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cline x1='2' y1='12' x2='22' y2='12'/%3E%3Cpath d='M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z'/%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <script src="//unpkg.com/globe.gl"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { transition: background-color 0.4s ease, color 0.4s ease; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .loader-text { animation: fadeInOut 2s ease-in-out infinite; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        .error-message { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .error-message.show { display: block; opacity: 1; }
        
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        
        #toast { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        #toast.show { opacity: 1; transform: translateY(0); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }

        #globeViz {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            transition: opacity 0.5s ease;
        }

        .glass-nav {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(203, 213, 225, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .dark .glass-nav {
            background-color: rgba(2, 6, 23, 0.7);
            border-bottom: 1px solid rgba(30, 41, 59, 0.4);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-200 antialiased bg-slate-50 dark:bg-slate-950">

    <div id="app" class="min-h-screen flex flex-col">
        <header id="main-header" class="fixed top-0 w-full z-50 transition-all duration-300 bg-transparent">
            <nav class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex items-center gap-3">
                        <div class="bg-gradient-to-br from-blue-500 to-cyan-600 p-2 rounded-xl text-white shadow-lg shadow-blue-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 dark:from-white dark:via-blue-200 dark:to-cyan-400 tracking-tight leading-none">
                                Travel Planner
                            </h1>
                            <span class="text-xs text-slate-500 dark:text-slate-400 font-medium tracking-wide">SMART TRAVEL PLANNER</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <button id="themeToggleBtn" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-white/10 text-slate-600 dark:text-slate-300 transition-colors focus:outline-none">
                            <span id="themeIcon" class="material-icons-outlined">light_mode</span>
                        </button>
                        <div id="auth-container" class="flex items-center gap-4"></div>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-grow">
            <section id="heroSection" class="relative overflow-hidden w-full h-screen flex items-center justify-center bg-slate-50 dark:bg-black transition-colors duration-500">
                
                <div id="globeViz"></div>

                <div class="container mx-auto px-4 text-center relative z-10 pointer-events-none select-none">
                    
                    <div class="max-w-3xl mx-auto transition-all duration-300">
                        
                        <h1 class="text-4xl sm:text-5xl md:text-6xl font-black tracking-tight text-slate-900 dark:text-white mb-6 drop-shadow-lg pointer-events-none">
                            Your Journey, <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500 dark:from-blue-400 dark:to-cyan-300">Reimagined.</span>
                        </h1>
                        
                        <p class="text-lg text-slate-900 font-semibold dark:text-slate-300 dark:font-medium mb-8 max-w-2xl mx-auto leading-relaxed drop-shadow-md pointer-events-none">
                            Tell us where you want to go and what you love.
                            <br> Our AI will craft a perfectly curated itinerary in seconds.
                        </p>
                        
                        <button id="startPlanningBtn" class="pointer-events-auto cursor-pointer relative z-50 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-xl shadow-lg shadow-blue-900/20 dark:shadow-blue-900/50 transition-all active:scale-[0.99] flex items-center gap-2 mx-auto border border-blue-500 hover:border-blue-400">
                            <span class="material-icons-outlined">add_location_alt</span>
                            <span>Plan a New Trip</span>
                        </button>

                    </div>
                </div>
            </section>

            <section id="planningSection" class="hidden container mx-auto px-4 max-w-3xl py-8 mt-24">
                <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-800 px-8 pb-8 pt-0 overflow-hidden relative transition-colors duration-300">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 via-cyan-500 to-blue-600"></div>
                    
                    <div id="errorMessage" class="error-message mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-300 rounded-xl flex items-center gap-2">
                        <span class="material-icons-outlined">error_outline</span>
                        <div>
                            <p class="font-bold text-sm">Oops!</p>
                            <p id="errorText" class="text-xs">Something went wrong.</p>
                        </div>
                    </div>

                    <h2 class="text-2xl font-black text-slate-900 dark:text-white mb-2 -mt-6">Trip Details</h2>
                    <p class="text-slate-500 dark:text-slate-400 mb-8 text-sm">Customize your perfect getaway.</p>
                    
                    <div class="space-y-6">
                        <div class="group">
                            <label class="flex items-center gap-1.5 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">
                                <span class="material-icons-outlined text-sm">place</span> Where to?
                            </label>
                            <div class="relative">
                                <input type="text" id="destination" class="block w-full rounded-xl border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white border-2 focus:border-blue-500 focus:bg-white dark:focus:bg-slate-800 focus:ring-0 py-3 px-4 text-base font-semibold transition-all hover:border-slate-300 dark:hover:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder="e.g. Paris, Tokyo">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="flex items-center gap-1.5 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">
                                    <span class="material-icons-outlined text-sm">today</span> Duration (Days)
                                </label>
                                <input type="number" id="days" min="1" max="14" class="block w-full rounded-xl border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white border-2 focus:border-blue-500 focus:bg-white dark:focus:bg-slate-800 focus:ring-0 py-3 px-4 text-sm font-semibold transition-all hover:border-slate-300 dark:hover:border-slate-600" placeholder="3">
                            </div>
                            <div>
                                <label class="flex items-center gap-1.5 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">
                                    <span class="material-icons-outlined text-sm">favorite</span> Interests
                                </label>
                                <input type="text" id="interests" class="block w-full rounded-xl border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white border-2 focus:border-blue-500 focus:bg-white dark:focus:bg-slate-800 focus:ring-0 py-3 px-4 text-sm font-semibold transition-all hover:border-slate-300 dark:hover:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder="e.g. Food, History">
                            </div>
                        </div>

                        <div class="flex items-center gap-3 bg-slate-100 dark:bg-slate-800/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors" onclick="document.getElementById('includeHotels').click()">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="includeHotels" class="w-5 h-5 text-blue-500 rounded focus:ring-blue-500 border-slate-400 dark:border-slate-600 bg-white dark:bg-slate-700 cursor-pointer accent-blue-500" checked onclick="event.stopPropagation()">
                            </div>
                            <label for="includeHotels" class="text-sm font-bold text-slate-700 dark:text-slate-300 cursor-pointer select-none">
                                Include Hotel Recommendations
                            </label>
                        </div>
                    </div>

                    <button id="generateBtn" class="w-full bg-slate-900 dark:bg-white hover:bg-slate-700 dark:hover:bg-slate-200 text-white dark:text-slate-900 font-bold py-4 px-6 rounded-xl shadow-lg transition-all active:scale-[0.99] flex items-center justify-center gap-2 mt-8">
                        <span class="material-icons-outlined">auto_awesome</span>
                        <span>Generate Itinerary</span>
                    </button>
                </div>
            </section>

            <section id="loadingSection" class="hidden text-center py-24 mt-20">
                <div class="flex flex-col items-center justify-center">
                    <div class="relative h-16 w-16 mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-slate-200 dark:border-slate-800"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-blue-500">
                            <span class="material-icons-outlined">flight</span>
                        </div>
                    </div>
                    <p class="text-lg font-bold text-slate-800 dark:text-slate-200">Crafting your perfect adventure...</p>
                    <p id="loaderText" class="loader-text mt-2 text-slate-500 font-medium text-sm">Packing your digital bags...</p>
                </div>
            </section>
            
            <section id="itinerarySection" class="hidden container mx-auto px-4 py-8 max-w-4xl mt-24">
                 <div class="bg-gradient-to-r from-blue-600 to-slate-800 dark:from-blue-900 dark:to-slate-900 rounded-2xl p-8 text-white mb-8 shadow-lg border border-transparent dark:border-slate-800">
                    <h2 class="text-3xl font-black flex items-center gap-3 mb-2">
                        <span class="material-icons-outlined text-blue-200 dark:text-blue-400">explore</span>
                        <span id="trip-title"></span>
                    </h2>
                    <p id="trip-subtitle" class="text-blue-100 dark:text-slate-400 font-medium"></p>
                </div>

                <div class="space-y-12 animate-fadeIn">
                    
                    <div id="hotel-section-container" class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-800 shadow-sm transition-colors">
                        <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4 flex items-center gap-2">
                            <span class="material-icons-outlined text-purple-500 dark:text-purple-400">hotel</span>
                            Top Stay Recommendations
                        </h3>
                        <div id="hotel-cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>

                    <div id="itinerary-content-container" class="space-y-8"></div>

                    <div class="text-center pt-8 pb-12">
                        <div class="flex gap-3 justify-center">
                            <button id="startOverBtn" class="flex items-center gap-2 bg-white dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-bold py-3 px-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm transition-all">
                                <span class="material-icons-outlined">refresh</span> Start Over
                            </button>
                            <button id="saveTripBtn" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-blue-900/50 transition-all">
                                <span class="material-icons-outlined">bookmark</span> Save Trip
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modals-container">
        <div id="myTripsModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-backdrop opacity-0 transition-opacity">
            <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col modal-content scale-95 opacity-0 transition-all border border-slate-200 dark:border-slate-800">
                <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 rounded-t-3xl">
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white flex items-center gap-2">
                        <span class="material-icons-outlined text-blue-500">history</span> My Saved Trips
                    </h2>
                    <button class="close-modal-btn text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div id="myTripsList" class="p-6 overflow-y-auto space-y-3 bg-slate-50 dark:bg-slate-950/30 flex-1"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-blue-900 text-blue-100 border border-blue-800 py-3 px-5 rounded-xl shadow-xl opacity-0 translate-y-4 font-medium flex items-center gap-3 z-[60]">
        <span class="material-icons-outlined text-blue-400">check_circle</span>
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentItineraryData = null;
        let currentUser = null;
        let world; 

        const elements = {
            header: document.getElementById('main-header'),
            heroSection: document.getElementById('heroSection'),
            planningSection: document.getElementById('planningSection'),
            loadingSection: document.getElementById('loadingSection'),
            itinerarySection: document.getElementById('itinerarySection'),
            authContainer: document.getElementById('auth-container'),
            myTripsList: document.getElementById('myTripsList'),
            modalsContainer: document.getElementById('modals-container'),
            themeToggleBtn: document.getElementById('themeToggleBtn'),
            themeIcon: document.getElementById('themeIcon')
        };

        // --- THEME TOGGLE ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            elements.themeIcon.textContent = isDark ? 'light_mode' : 'dark_mode';
            
            if (world) {
                if (isDark) {
                    world.backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png');
                    world.backgroundColor('rgba(0,0,0,0)');
                    world.globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg');
                } else {
                    world.backgroundImageUrl(null);
                    world.backgroundColor('#f8fafc'); 
                    world.globeImageUrl('//unpkg.com/three-globe/example/img/earth-day.jpg');
                }
            }
        }
        elements.themeToggleBtn.addEventListener('click', toggleTheme);

        // --- AUTH ---
        window.handleLogin = function() {
            signInWithPopup(auth, provider)
                .then((result) => showToast(`Welcome, ${result.user.displayName}!`))
                .catch((error) => showToast("Login failed."));
        }

        window.handleLogout = function() {
            signOut(auth).then(() => {
                showToast("Logged out.");
                showSection(elements.heroSection);
            });
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthUI();
        });

        function updateAuthUI() {
            if (currentUser) {
                elements.authContainer.innerHTML = `
                    <button id="headerMyTripsBtn" class="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-blue-500 dark:text-slate-300 dark:hover:text-blue-400 bg-slate-100 hover:bg-slate-200 dark:bg-white/5 dark:hover:bg-white/10 px-4 py-2 rounded-full transition-all border border-slate-200 dark:border-white/10">
                        <span class="material-icons-outlined">history</span> <span class="hidden sm:inline">History</span>
                    </button>
                    <div class="flex items-center gap-2 pl-2 border-l border-slate-300 dark:border-slate-700">
                        <img src="${currentUser.photoURL}" alt="Profile" class="w-9 h-9 rounded-full border border-slate-300 dark:border-slate-600">
                        <button onclick="handleLogout()" class="w-10 h-10 flex items-center justify-center bg-slate-100 hover:bg-red-50 dark:bg-white/5 dark:hover:bg-red-900/30 text-slate-500 hover:text-red-500 dark:text-slate-400 dark:hover:text-red-400 rounded-full transition-all" title="Logout">
                            <span class="material-icons-outlined text-xl">logout</span>
                        </button>
                    </div>
                `;
                document.getElementById('headerMyTripsBtn').addEventListener('click', loadAndShowTrips);
            } else {
                // MODIFIED: White BG for Light Mode, Dark BG for Dark Mode
                elements.authContainer.innerHTML = `
                    <button onclick="handleLogin()" class="flex items-center gap-3 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-white font-medium py-2 px-4 rounded-full transition-all border border-slate-300 dark:border-slate-700 shadow-sm hover:shadow-md">
                        <div class="p-0.5 rounded-full flex items-center justify-center w-5 h-5">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-full h-full">
                        </div>
                        <span class="text-sm">Sign in</span>
                    </button>
                `;
            }
            lucide.createIcons();
        }

        // --- DB LOGIC ---
        function saveCurrentTrip() {
            if (!currentUser) { showToast("Please sign in to save."); handleLogin(); return; }
            if (!currentItineraryData) return;
            push(ref(db, 'users/' + currentUser.uid + '/trips'), { ...currentItineraryData, timestamp: Date.now() })
                .then(() => showToast("Trip saved!"))
                .catch(() => showToast("Error saving."));
        }

        function loadAndShowTrips() {
            if (!currentUser) { showToast("Please sign in first."); return; }
            showModal(document.getElementById('myTripsModal'));
            elements.myTripsList.innerHTML = '<div class="text-center py-4"><span class="material-icons-outlined animate-spin text-blue-500">refresh</span> Syncing...</div>';
            
            onValue(ref(db, 'users/' + currentUser.uid + '/trips'), (snapshot) => {
                elements.myTripsList.innerHTML = '';
                const data = snapshot.val();
                if (!data) { elements.myTripsList.innerHTML = `<p class="text-slate-500 text-center">No saved trips found.</p>`; return; }
                Object.entries(data).reverse().forEach(([key, trip]) => {
                    const item = document.createElement('div');
                    item.className = 'bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 flex justify-between items-center group hover:border-blue-400 dark:hover:border-blue-500/50 transition-colors shadow-sm';
                    item.innerHTML = `
                        <div><p class="font-bold text-slate-800 dark:text-slate-200">${trip.details.destination}</p><p class="text-sm text-slate-500 dark:text-slate-400">${trip.details.days} Days • ${trip.details.interests}</p></div>
                        <div class="flex items-center gap-2"><button class="load-trip-btn bg-blue-100 hover:bg-blue-200 text-blue-700 dark:bg-blue-600 dark:hover:bg-blue-500 dark:text-white font-semibold py-1.5 px-3 rounded-md text-sm transition-colors">Load</button><button class="delete-trip-btn p-2 rounded-md hover:bg-red-50 dark:hover:bg-red-900/30 text-red-500 dark:text-red-400 transition-colors"><span class="material-icons-outlined">delete</span></button></div>`;
                    item.querySelector('.load-trip-btn').onclick = () => { renderItinerary(trip, trip.details); showSection(elements.itinerarySection); closeModal(document.getElementById('myTripsModal')); };
                    item.querySelector('.delete-trip-btn').onclick = () => { if(confirm('Delete?')) remove(ref(db, 'users/' + currentUser.uid + '/trips/' + key)); };
                    elements.myTripsList.appendChild(item);
                });
            });
        }

        // --- GENERATION ---
        function startGeneration() {
            document.getElementById('errorMessage').classList.remove('show');
            showSection(elements.loadingSection);
            document.getElementById('generateBtn').disabled = true;
            const dest = document.getElementById('destination').value.split(',')[0] || "your destination";
            document.getElementById('loaderText').textContent = `Mapping adventure for ${dest}...`;

            generateItinerary()
                .then(data => {
                    if (data && data.days) { renderItinerary(data); showSection(elements.itinerarySection); } 
                    else { throw new Error("Invalid format."); }
                })
                .catch(err => { console.error(err); document.getElementById('errorText').textContent = err.message; document.getElementById('errorMessage').classList.add('show'); showSection(elements.planningSection); })
                .finally(() => { document.getElementById('generateBtn').disabled = false; });
        }

        async function generateItinerary() {
            const dest = document.getElementById('destination').value;
            const days = document.getElementById('days').value;
            const interests = document.getElementById('interests').value;
            const hotels = document.getElementById('includeHotels').checked;
            if (!dest || !days || !interests) throw new Error("Please fill out all details.");

            const schema = { type: "OBJECT", properties: { "tripTitle": { type: "STRING" }, "days": { type: "ARRAY", items: { type: "OBJECT", properties: { "day": { type: "NUMBER" }, "title": { type: "STRING" }, "events": { type: "ARRAY", items: { type: "OBJECT", properties: { "time": { type: "STRING" }, "title": { type: "STRING" }, "locationName": { type: "STRING" }, "description": { type: "STRING" }, "icon": { type: "STRING" }, "latitude": { type: "NUMBER" }, "longitude": { type: "NUMBER" } }, required: ["time", "title", "locationName", "description", "icon", "latitude", "longitude"] } } }, required: ["day", "title", "events"] } }, "hotelRecommendations": { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "style": { "type": "STRING" }, "description": { "type": "STRING" }, "latitude": { "type": "NUMBER" }, "longitude": { "type": "NUMBER" } }, required: ["name", "style", "description", "latitude", "longitude"] } } }, required: ["tripTitle", "days", "hotelRecommendations"] };
            
            const prompt = `Plan a ${days}-day trip to ${dest}. Interests: ${interests}. ${hotels ? 'Include 3 hotels.' : 'No hotels.'} Use icons: map-pin, camera, soup, shopping-cart. Real restaurant names required.`;
            const apiKey = "Your_API_KEY"; 
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } })
            });
            const json = await resp.json();
            return JSON.parse(json.candidates[0].content.parts[0].text);
        }

        function renderItinerary(data, tripDetails = null) {
            const details = tripDetails || { destination: document.getElementById('destination').value, days: document.getElementById('days').value, interests: document.getElementById('interests').value };
            currentItineraryData = { ...data, details };
            document.getElementById('trip-title').textContent = data.tripTitle || `Trip to ${details.destination}`;
            document.getElementById('trip-subtitle').textContent = `${details.days} Days • ${details.interests}`;

            const hCont = document.getElementById('hotel-cards');
            const hSec = document.getElementById('hotel-section-container');
            hCont.innerHTML = '';
            if (data.hotelRecommendations?.length) {
                hSec.classList.remove('hidden');
                data.hotelRecommendations.forEach(h => {
                    hCont.innerHTML += `<div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-purple-200 dark:border-purple-900/50 relative overflow-hidden group"><div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div><div class="flex gap-4"><div class="bg-purple-100 dark:bg-purple-900/30 p-2.5 rounded-lg h-fit text-purple-600 dark:text-purple-400"><span class="material-icons-outlined">bed</span></div><div><h4 class="font-bold text-slate-800 dark:text-slate-200 text-base mb-1">${h.name}</h4><p class="text-xs text-slate-500 dark:text-slate-400 mb-2">${h.description}</p><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.name + " " + details.destination)}" target="_blank" class="text-xs font-bold text-purple-600 dark:text-purple-400 hover:underline flex items-center gap-1"><span class="material-icons-outlined text-sm">map</span> View on Map</a></div></div></div>`;
                });
            } else { hSec.classList.add('hidden'); }

            const tCont = document.getElementById('itinerary-content-container');
            tCont.innerHTML = '';
            data.days.forEach((day, dIdx) => {
                let html = `<div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-800 shadow-sm"><div class="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-800 pb-4"><div><h3 class="text-xl font-bold text-slate-900 dark:text-white">Day ${day.day}</h3><p class="text-slate-500 dark:text-slate-400 text-sm">${day.title}</p></div></div><div class="relative pl-4 space-y-6"><div class="absolute left-[19px] top-3 bottom-6 w-0.5 bg-slate-200 dark:bg-slate-800"></div>`;
                day.events.forEach((ev, eIdx) => {
                    const isFood = /lunch|dinner|breakfast|food/i.test(ev.title+ev.description);
                    html += `<div class="flex gap-4 group relative z-10"><div class="flex flex-col items-center pt-1"><div class="w-10 h-10 rounded-full border-4 border-white dark:border-slate-900 shadow-md flex items-center justify-center ${isFood ? 'bg-orange-100 dark:bg-orange-900/40 text-orange-600 dark:text-orange-400' : 'bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400'}"><span class="material-icons-outlined text-lg">${isFood ? 'restaurant' : 'place'}</span></div></div><div class="flex-1 pb-2 bg-slate-50 dark:bg-slate-800/40 rounded-xl p-4 border border-slate-100 dark:border-slate-800 hover:border-slate-300 dark:hover:border-slate-600 transition-colors"><div class="flex justify-between items-start mb-1"><span class="text-xs font-bold px-2 py-0.5 rounded border bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700">${ev.time}</span></div><h4 class="text-base font-bold text-slate-800 dark:text-slate-100 mb-1">${ev.locationName}</h4><p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">${ev.description}</p></div></div>`;
                });
                html += `</div></div>`;
                tCont.innerHTML += html;
            });
        }

        function showSection(section) {
            [elements.heroSection, elements.planningSection, elements.loadingSection, elements.itinerarySection].forEach(s => s.classList.add('hidden'));
            document.getElementById('errorMessage').classList.remove('show');
            section.classList.remove('hidden');
            window.scrollTo(0, 0);
            if (section.id === 'heroSection') { elements.header.classList.remove('glass-nav'); elements.header.classList.add('bg-transparent'); } 
            else { elements.header.classList.remove('bg-transparent'); elements.header.classList.add('glass-nav'); }
        }

        function showToast(m) { const t = document.getElementById('toast'); document.getElementById('toastMessage').textContent = m; t.classList.remove('opacity-0', 'translate-y-4'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3500); }
        function showModal(m) { m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'); }, 10); }
        function closeModal(m) { if(!m)return; m.classList.add('opacity-0'); m.querySelector('.modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); }
        elements.modalsContainer.addEventListener('click', (e) => (e.target.closest('.close-modal-btn') || e.target.matches('.modal-backdrop')) && closeModal(e.target.closest('.modal-backdrop')));

        // --- BUTTON LISTENER ---
        const startBtn = document.getElementById('startPlanningBtn');
        if(startBtn) {
            startBtn.addEventListener('click', () => {
                if (currentUser) { showSection(elements.planningSection); } 
                else { showToast("Please sign in to plan."); handleLogin(); }
            });
        }
        document.getElementById('generateBtn').addEventListener('click', startGeneration);
        document.getElementById('startOverBtn').addEventListener('click', () => showSection(elements.heroSection));
        document.getElementById('saveTripBtn').addEventListener('click', saveCurrentTrip);

        window.onload = function() {
            lucide.createIcons();
            const N = 15;
            const arcsData = [...Array(N).keys()].map(() => ({ startLat: (Math.random()-0.5)*180, startLng: (Math.random()-0.5)*360, endLat: (Math.random()-0.5)*180, endLng: (Math.random()-0.5)*360, color: ['#ffffff', '#3b82f6'][Math.round(Math.random())] }));
            const hero = document.getElementById('heroSection');
            
            world = Globe()(document.getElementById('globeViz'))
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
                .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                .atmosphereColor('#3b82f6').atmosphereAltitude(0.15)
                .arcsData(arcsData).arcColor('color').arcDashLength(0.4).arcDashGap(2).arcDashAnimateTime(2000).arcStroke(0.3)
                .width(hero.clientWidth).height(hero.clientHeight);
            
            world.controls().autoRotate = true;
            world.controls().autoRotateSpeed = 2.0;
            world.pointOfView({ 
                lat: 25, 
                altitude: 1.65 
            });    
            window.addEventListener('resize', () => { world.width(hero.clientWidth); world.height(hero.clientHeight); });
        }
    </script>
</body>

</html>
