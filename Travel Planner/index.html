<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Planner</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' rx='6' fill='%23059669'/%3E%3Cpath fill='white' d='M2.5 19h19v2h-19zm19.57-9.36c-.21-.8-1.04-1.28-1.84-1.06L14.92 10l-6.9-6.4c-.37-.37-.89-.6-1.43-.6h-.03c-.54 0-1.01.4-1.08.94l-.25 2.4 7.15 7.9-3.32.9-1.76-1.44-1.39.37-.2 3.41.87 3.06 16.11-4.32c.8-.21.6-2.71.39-3.51z'/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader-text { animation: fadeInOut 2s ease-in-out infinite; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .error-message { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .error-message.show { display: block; opacity: 1; }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        #toast { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        #toast.show { opacity: 1; transform: translateY(0); }
        .draggable { cursor: grab; user-select: none; }
        .draggable:active { cursor: grabbing; }
        .dragging { opacity: 0.5; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .drag-over { border-top: 2px dashed #059669; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="text-slate-900 antialiased bg-slate-50">

    <div id="app" class="min-h-screen flex flex-col">
        <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
            <nav class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-18 py-4">
                    <div class="flex items-center gap-3">
                        <div class="bg-emerald-600 p-1.5 rounded-lg text-white shadow-lg shadow-emerald-200">
                            <span class="material-icons-outlined text-xl block">flight_takeoff</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-black text-slate-800 tracking-tight leading-none">Travel Planner</h1>
                            <span class="text-xs text-slate-500 font-medium tracking-wide">SMART TRAVEL PLANNER</span>
                        </div>
                    </div>
                    <div id="auth-container" class="flex items-center gap-4"></div>
                </div>
            </nav>
        </header>

        <main class="flex-grow">
            <section id="heroSection" class="container mx-auto px-4 py-6 sm:py-8 text-center">
                <div class="max-w-3xl mx-auto">
                    <div class="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mb-6 mx-auto shadow-sm">
                        <span class="material-icons-outlined text-4xl">auto_awesome</span>
                    </div>
                    <h1 class="text-4xl sm:text-5xl md:text-6xl font-black tracking-tight text-slate-900 mb-6">
                        Your Journey, <span class="text-emerald-600">Reimagined.</span>
                    </h1>
                    <p class="text-lg text-slate-600 mb-8 max-w-2xl mx-auto leading-relaxed">
                        Tell us where you want to go and what you love. Our AI will craft a perfectly curated itinerary in seconds.
                    </p>
                    <button id="startPlanningBtn" class="bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-8 rounded-xl shadow-xl shadow-slate-200 transition-all active:scale-[0.99] flex items-center gap-2 mx-auto">
                        <span class="material-icons-outlined">add_location_alt</span>
                        <span>Plan a New Trip</span>
                    </button>
                </div>
            </section>

            <section id="planningSection" class="hidden container mx-auto px-4 max-w-3xl">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 px-8 pb-8 pt-0 overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-emerald-400 via-teal-500 to-emerald-600"></div>
                    
                    <div id="errorMessage" class="error-message mb-6 p-4 bg-red-50 border border-red-100 text-red-700 rounded-xl flex items-center gap-2">
                        <span class="material-icons-outlined">error_outline</span>
                        <div>
                            <p class="font-bold text-sm">Oops!</p>
                            <p id="errorText" class="text-xs">Something went wrong.</p>
                        </div>
                    </div>

                    <h2 class="text-2xl font-black text-slate-800 mb-2 -mt-6">Trip Details</h2>
                    <p class="text-slate-500 mb-8 text-sm">Customize your perfect getaway.</p>
                    
                    <div class="space-y-6">
                        <div class="group">
                            <label class="flex items-center gap-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                <span class="material-icons-outlined text-sm">place</span> Where to?
                            </label>
                            <div class="relative">
                                <input type="text" id="destination" class="block w-full rounded-xl border-slate-200 bg-slate-50 border-2 border-transparent focus:border-emerald-500 focus:bg-white focus:ring-0 py-3 px-4 text-base font-semibold transition-all hover:bg-slate-100 placeholder-slate-400" placeholder="e.g. Paris, Tokyo">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="flex items-center gap-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                    <span class="material-icons-outlined text-sm">today</span> Duration (Days)
                                </label>
                                <input type="number" id="days" min="1" max="14" class="block w-full rounded-xl border-slate-200 bg-slate-50 border-2 border-transparent focus:border-emerald-500 focus:bg-white focus:ring-0 py-3 px-4 text-sm font-semibold transition-all hover:bg-slate-100" placeholder="3">
                            </div>
                            <div>
                                <label class="flex items-center gap-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">
                                    <span class="material-icons-outlined text-sm">favorite</span> Interests
                                </label>
                                <input type="text" id="interests" class="block w-full rounded-xl border-slate-200 bg-slate-50 border-2 border-transparent focus:border-emerald-500 focus:bg-white focus:ring-0 py-3 px-4 text-sm font-semibold transition-all hover:bg-slate-100 placeholder-slate-400" placeholder="e.g. Food, History">
                            </div>
                        </div>

                        <div class="flex items-center gap-3 bg-slate-50 p-4 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors" onclick="document.getElementById('includeHotels').click()">
                            <div class="relative flex items-center">
                                <input type="checkbox" id="includeHotels" class="w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500 border-gray-300 cursor-pointer accent-emerald-600" checked onclick="event.stopPropagation()">
                            </div>
                            <label for="includeHotels" class="text-sm font-bold text-slate-700 cursor-pointer select-none">
                                Include Hotel Recommendations
                            </label>
                        </div>
                    </div>

                    <button id="generateBtn" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-6 rounded-xl shadow-xl shadow-slate-200 transition-all active:scale-[0.99] flex items-center justify-center gap-2 mt-8">
                        <span class="material-icons-outlined">auto_awesome</span>
                        <span>Generate Itinerary</span>
                    </button>
                </div>
            </section>

            <section id="loadingSection" class="hidden text-center py-24">
                <div class="flex flex-col items-center justify-center">
                    <div class="relative h-16 w-16 mb-6">
                        <div class="absolute inset-0 rounded-full border-4 border-slate-100"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-emerald-500 border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-emerald-600">
                            <span class="material-icons-outlined">flight</span>
                        </div>
                    </div>
                    <p class="text-lg font-bold text-slate-700">Crafting your perfect adventure...</p>
                    <p id="loaderText" class="loader-text mt-2 text-slate-400 text-sm font-medium">Packing your digital bags...</p>
                </div>
            </section>
            
            <section id="itinerarySection" class="hidden container mx-auto px-4 py-8 max-w-4xl">
                 <div class="bg-gradient-to-r from-slate-900 to-slate-800 rounded-2xl p-8 text-white mb-8 shadow-lg">
                    <h2 class="text-3xl font-black flex items-center gap-3 mb-2">
                        <span class="material-icons-outlined text-emerald-400">explore</span>
                        <span id="trip-title"></span>
                    </h2>
                    <p id="trip-subtitle" class="text-slate-400 font-medium"></p>
                </div>

                <div class="space-y-12 animate-fadeIn">
                    
                    <div id="hotel-section-container" class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <span class="material-icons-outlined text-purple-600">hotel</span>
                            Top Stay Recommendations
                        </h3>
                        <div id="hotel-cards" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>

                    <div id="itinerary-content-container" class="space-y-8"></div>

                    <div class="text-center pt-8 pb-12">
                        <div class="flex gap-3 justify-center">
                            <button id="startOverBtn" class="flex items-center gap-2 bg-white hover:bg-slate-50 text-slate-700 font-bold py-3 px-6 rounded-xl border border-slate-200 shadow-sm transition-all">
                                <span class="material-icons-outlined">refresh</span> Start Over
                            </button>
                            <button id="saveTripBtn" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-emerald-100 transition-all">
                                <span class="material-icons-outlined">bookmark</span> Save Trip
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modals-container">
        <div id="myTripsModal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-4 modal-backdrop opacity-0 transition-opacity">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg max-h-[80vh] flex flex-col modal-content scale-95 opacity-0 transition-all">
                <div class="flex justify-between items-center p-6 border-b border-slate-100 bg-slate-50 rounded-t-3xl">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <span class="material-icons-outlined text-emerald-600">history</span> My Saved Trips
                    </h2>
                    <button class="close-modal-btn text-slate-400 hover:text-slate-600 transition-colors">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>
                <div id="myTripsList" class="p-6 overflow-y-auto space-y-3 bg-slate-50/50 flex-1"></div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-slate-800 text-white py-3 px-5 rounded-xl shadow-xl opacity-0 translate-y-4 font-medium flex items-center gap-3 z-[60]">
        <span class="material-icons-outlined text-emerald-400">check_circle</span>
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- FIREBASE CONFIGURATION ---//add your Firebase config here
      const firebaseConfig = {
  apiKey: "AIzaSyBi.................",
  authDomain: "travelplanner-.....",
  databaseURL: "https://travelplanner......",
  projectId: "travelplanner-a3248",
  storageBucket: "travelplanner-a3248..........",
  messagingSenderId: "97934149826",
  appId: "1:97934149826:web:4ca59...............",
  measurementId: "G-........."
};

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // --- GLOBAL VARIABLES ---
        let currentItineraryData = null;
        let currentUser = null;

        // --- UI ELEMENTS ---
        const elements = {
            heroSection: document.getElementById('heroSection'),
            planningSection: document.getElementById('planningSection'),
            loadingSection: document.getElementById('loadingSection'),
            itinerarySection: document.getElementById('itinerarySection'),
            authContainer: document.getElementById('auth-container'),
            myTripsList: document.getElementById('myTripsList'),
            modalsContainer: document.getElementById('modals-container'),
        };

        // --- AUTHENTICATION ---
        window.handleLogin = function() {
            signInWithPopup(auth, provider)
                .then((result) => showToast(`Welcome, ${result.user.displayName}!`))
                .catch((error) => { console.error(error); showToast("Login failed."); });
        }

        window.handleLogout = function() {
            signOut(auth).then(() => {
                showToast("Logged out.");
                showSection(elements.heroSection);
            });
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthUI();
        });

        function updateAuthUI() {
            if (currentUser) {
                elements.authContainer.innerHTML = `
                    <button id="headerMyTripsBtn" class="flex items-center gap-2 text-sm font-bold text-slate-600 hover:text-emerald-600 bg-slate-100 hover:bg-emerald-50 px-4 py-2 rounded-full transition-all">
                        <span class="material-icons-outlined">history</span> <span class="hidden sm:inline">History</span>
                    </button>
                    <div class="flex items-center gap-2 pl-2 border-l border-slate-200">
                        <img src="${currentUser.photoURL}" alt="Profile" class="w-9 h-9 rounded-full border border-slate-300">
                        <button onclick="handleLogout()" class="w-10 h-10 flex items-center justify-center bg-slate-100 hover:bg-red-50 text-slate-500 hover:text-red-600 rounded-full transition-all" title="Logout">
                            <span class="material-icons-outlined text-xl">logout</span>
                        </button>
                    </div>
                `;
                document.getElementById('headerMyTripsBtn').addEventListener('click', loadAndShowTrips);
            } else {
                // CUSTOM BLUE BUTTON mimicking the Google One
                elements.authContainer.innerHTML = `
                    <button onclick="handleLogin()" class="flex items-center gap-3 bg-white-600 hover:bg-blue-300 text-black font-medium py-2 px-4 rounded-full transition-all border border-slate-200 shadow-sm hover:shadow-md">
                        <div class="bg-white p-1 rounded-full flex items-center justify-center w-6 h-6">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4">
                        </div>
                        <span class="text-sm">Sign in with Google</span>
                    </button>
                `;
            }
            lucide.createIcons();
        }

        // --- REALTIME DATABASE LOGIC ---
        function saveCurrentTrip() {
            if (!currentUser) {
                showToast("Please sign in to save trips.");
                handleLogin();
                return;
            }
            if (!currentItineraryData) return;

            const tripsRef = ref(db, 'users/' + currentUser.uid + '/trips');
            push(tripsRef, {
                ...currentItineraryData,
                timestamp: Date.now()
            }).then(() => {
                showToast("Trip saved to cloud!");
            }).catch((error) => {
                console.error(error);
                showToast("Error saving trip.");
            });
        }

        function loadAndShowTrips() {
            if (!currentUser) {
                showToast("Please sign in first.");
                return;
            }

            showModal(document.getElementById('myTripsModal'));
            const listContainer = elements.myTripsList;
            listContainer.innerHTML = '<div class="text-center py-4"><span class="material-icons-outlined animate-spin text-emerald-600">refresh</span> Syncing...</div>';

            const tripsRef = ref(db, 'users/' + currentUser.uid + '/trips');
            
            onValue(tripsRef, (snapshot) => {
                listContainer.innerHTML = '';
                const data = snapshot.val();

                if (!data) {
                    listContainer.innerHTML = `<p class="text-slate-500 text-center">No saved trips found.</p>`;
                    return;
                }

                const tripsArray = Object.entries(data).map(([key, value]) => ({ id: key, ...value })).reverse();
                const list = document.createElement('div');
                list.className = 'space-y-4';

                tripsArray.forEach((trip) => {
                    const item = document.createElement('div');
                    item.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200 flex justify-between items-center';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold text-slate-800">${trip.details.destination}</p>
                            <p class="text-sm text-slate-500">${trip.details.days} Days • ${trip.details.interests}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="load-trip-btn bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-1.5 px-3 rounded-md text-sm">Load</button>
                            <button class="delete-trip-btn p-2 rounded-md hover:bg-red-100 text-red-500">
                                <span class="material-icons-outlined">delete</span>
                            </button>
                        </div>
                    `;
                    
                    item.querySelector('.load-trip-btn').onclick = () => {
                        renderItinerary(trip, trip.details);
                        showSection(elements.itinerarySection);
                        closeModal(document.getElementById('myTripsModal'));
                    };

                    item.querySelector('.delete-trip-btn').onclick = () => {
                        if(confirm('Delete this trip permanently?')) {
                            const tripRef = ref(db, 'users/' + currentUser.uid + '/trips/' + trip.id);
                            remove(tripRef); 
                        }
                    };
                    list.appendChild(item);
                });
                listContainer.appendChild(list);
            });
        }

        // --- AI GENERATION LOGIC ---
        function startGeneration() {
            document.getElementById('errorMessage').classList.remove('show');
            showSection(elements.loadingSection);
            document.getElementById('generateBtn').disabled = true;
            
            const destinationCity = document.getElementById('destination').value.split(',')[0] || "your destination";
            document.getElementById('loaderText').textContent = `Mapping adventure for ${destinationCity}...`;

            generateItinerary()
                .then(itineraryData => {
                    if (itineraryData && itineraryData.days) {
                       renderItinerary(itineraryData);
                       showSection(elements.itinerarySection);
                    } else { throw new Error("Invalid itinerary format."); }
                })
                .catch(err => { console.error(err); document.getElementById('errorText').textContent = err.message; document.getElementById('errorMessage').classList.add('show'); showSection(elements.planningSection); })
                .finally(() => { document.getElementById('generateBtn').disabled = false; });
        }

        async function generateItinerary() {
            const destination = document.getElementById('destination').value;
            const days = document.getElementById('days').value;
            const interests = document.getElementById('interests').value;
            const includeHotels = document.getElementById('includeHotels').checked;

            if (!destination || !days || !interests) { throw new Error("Please fill out all the trip details."); }
            
            const schema = { 
                type: "OBJECT", 
                properties: { 
                    "tripTitle": { type: "STRING" },
                    "days": { type: "ARRAY", items: { type: "OBJECT", properties: { "day": { type: "NUMBER" }, "title": { type: "STRING" }, "events": { type: "ARRAY", items: { type: "OBJECT", properties: { "time": { type: "STRING" }, "title": { type: "STRING" }, "locationName": { type: "STRING" }, "description": { type: "STRING" }, "icon": { type: "STRING" }, "latitude": { type: "NUMBER" }, "longitude": { type: "NUMBER" } }, required: ["time", "title", "locationName", "description", "icon", "latitude", "longitude"] } } }, required: ["day", "title", "events"] } }, 
                    "hotelRecommendations": { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "style": { "type": "STRING" }, "description": { "type": "STRING" }, "latitude": { "type": "NUMBER" }, "longitude": { "type": "NUMBER" } }, required: ["name", "style", "description", "latitude", "longitude"] } }
                }, 
                required: ["tripTitle", "days", "hotelRecommendations"] 
            };
            
            const validIcons = ["map-pin", "camera", "soup", "leaf", "shopping-cart", "trees", "beer", "gamepad-2", "heart", "gem", "bar-chart-2", "plane", "bus", "train", "utensils-crossed", "landmark", "mountain", "palace", "ticket", "log-in", "bed-double"];
            
            const hotelInstruction = includeHotels 
                ? "2. Provide 3 distinct hotel recommendations." 
                : "2. RETURN AN EMPTY ARRAY '[]' for hotelRecommendations. DO NOT generate any hotels.";

            const systemPrompt = `You are an expert Travel Planner. Create a ${days}-day itinerary for ${destination} focusing on these interests: ${interests}.
            Key Constraints:
            1. Logically sequenced route.
            ${hotelInstruction}
            3. Choose icons from: ${validIcons.join(', ')}.
            4. For each event, provide specific location name, coordinates, and description.
            5. CRITICAL: For any 'Lunch' or 'Dinner' or 'Breakfast' event, the locationName MUST be a REAL, SPECIFIC RESTAURANT Name (e.g. 'Paradise Biryani House', 'Karim's', 'Saravana Bhavan'). Do NOT use generic names like 'Local Restaurant' or 'Street Food'. This is required for search links to work.`;
            
            const userQuery = `Plan a ${days} day trip to ${destination}. Interests: ${interests}.`;
            
            return callGenerativeAPI(userQuery, systemPrompt, schema);
        }
        
        async function callGenerativeAPI(userQuery, systemPrompt, schema) {
            // *** API KEY RESTORED FROM PREVIOUS CONVERSATION ***
            const apiKey = //add your API key here;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: { responseMimeType: "application/json", responseSchema: schema },
            };

            let response; 
            let retries = 3; 
            let delay = 1000;

            for (let i = 0; i < retries; i++) {
                try {
                    response = await fetch(apiUrl, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });

                    if (response.ok) {
                        const result = await response.json(); 
                        let jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonText) { 
                            jsonText = jsonText.replace(/```json/g, '').replace(/```/g, '').trim();
                            return JSON.parse(jsonText); 
                        } else { throw new Error("API returned an empty response."); }
                    } else {
                        if (response.status === 429 || response.status >= 500) { 
                            await new Promise(res => setTimeout(res, delay)); 
                            delay *= 2; 
                            continue; 
                        }
                        const errorBody = await response.json();
                        throw new Error(`API request failed: ${response.status}. ${errorBody?.error?.message || ''}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(res => setTimeout(res, delay)); 
                    delay *= 2;
                }
            }
        }

        function renderItinerary(itineraryData, tripDetails = null) {
            const details = tripDetails || {
                destination: document.getElementById('destination').value,
                days: document.getElementById('days').value,
                interests: document.getElementById('interests').value,
            };
            currentItineraryData = { ...itineraryData, details };
            
            document.getElementById('trip-title').textContent = itineraryData.tripTitle || `Trip to ${details.destination}`;
            document.getElementById('trip-subtitle').textContent = `${details.days} Days • ${details.interests}`;

            // RENDER HOTELS
            const hotelContainer = document.getElementById('hotel-section-container');
            const hotelCardsContainer = document.getElementById('hotel-cards');
            hotelCardsContainer.innerHTML = ''; 

            if (itineraryData.hotelRecommendations && itineraryData.hotelRecommendations.length > 0) {
                hotelContainer.classList.remove('hidden'); 
                itineraryData.hotelRecommendations.forEach(hotel => { 
                    const card = document.createElement('div'); 
                    card.className = "bg-white rounded-xl p-4 border border-purple-100 shadow-sm relative overflow-hidden group hover:border-purple-300 transition-all";
                    card.innerHTML = `
                        <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                        <div class="flex gap-4">
                            <div class="bg-purple-50 p-2.5 rounded-lg h-fit text-purple-600">
                                <span class="material-icons-outlined">bed</span>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-base mb-1">${hotel.name}</h4>
                                <p class="text-xs text-slate-500 mb-2 leading-relaxed">${hotel.description}</p>
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.name + " " + details.destination)}" target="_blank" class="text-xs font-bold text-purple-600 hover:text-purple-800 flex items-center gap-1">
                                    <span class="material-icons-outlined text-sm">map</span> View on Map
                                </a>
                            </div>
                        </div>
                    `; 
                    hotelCardsContainer.appendChild(card); 
                });
            } else {
                hotelContainer.classList.add('hidden');
            }
            
            // RENDER TIMELINE
            const itineraryContentContainer = document.getElementById('itinerary-content-container');
            itineraryContentContainer.innerHTML = '';
            itineraryData.days.forEach((day, dayIndex) => { 
                const dayContainer = document.createElement('div'); 
                dayContainer.className = "bg-white rounded-2xl p-6 border border-slate-200 shadow-sm relative overflow-hidden day-events-container";
                dayContainer.dataset.dayIndex = dayIndex;
                
                let mapsUrl = "#";
                const coords = day.events.filter(e => e.locationName);
                
                if (coords.length >= 2) {
                    const origin = encodeURIComponent(coords[0].locationName + ", " + details.destination);
                    const dest = encodeURIComponent(coords[coords.length - 1].locationName + ", " + details.destination);
                    let waypoints = "";
                    if (coords.length > 2) {
                        const wpList = coords.slice(1, -1).map(e => encodeURIComponent(e.locationName + ", " + details.destination)).join("|");
                        waypoints = `&waypoints=${wpList}`;
                    }
                    mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}${waypoints}&travelmode=driving`;
                } else if (coords.length === 1) {
                    mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(coords[0].locationName + ", " + details.destination)}`;
                }

                let contentHTML = `
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">Day ${day.day}</h3>
                            <p class="text-slate-500 text-sm font-medium">${day.title}</p>
                        </div>
                        <a href="${mapsUrl}" target="_blank" class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide transition-all">
                            <span class="material-icons-outlined text-sm">map</span> Route Map
                        </a>
                    </div>
                    <div class="relative pl-4 space-y-6">
                        <div class="absolute left-[19px] top-3 bottom-6 w-0.5 bg-slate-200"></div>
                `; 
                
                (day.events || []).forEach((event, eventIndex) => { 
                    const isFood = /lunch|dinner|breakfast|snack|meal|cafe|restaurant|food/i.test(event.title + event.description + event.icon);
                    const encodedLoc = encodeURIComponent(event.locationName + " " + details.destination);
                    const mapsLoc = encodeURIComponent(event.locationName + ", " + details.destination);
                    
                    contentHTML += `
                    <div class="flex gap-4 group relative z-10" data-day-index="${dayIndex}" data-event-index="${eventIndex}">
                        <div class="flex flex-col items-center pt-1">
                            <div class="w-10 h-10 rounded-full border-4 border-white shadow-md flex items-center justify-center 
                                ${isFood ? 'bg-orange-100 text-orange-600' : 'bg-emerald-100 text-emerald-600'}">
                                <span class="material-icons-outlined text-lg">${isFood ? 'restaurant' : 'place'}</span>
                            </div>
                        </div>
                        <div class="flex-1 pb-2 bg-slate-50/50 rounded-xl p-4 border border-slate-100 hover:border-slate-300 transition-colors">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded border bg-white text-slate-600 border-slate-200">${event.time}</span>
                                
                                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button class="move-btn-up p-1 hover:bg-white rounded text-slate-400 hover:text-slate-700 disabled:opacity-0 transition-all" data-day="${dayIndex}" data-idx="${eventIndex}" ${eventIndex === 0 ? 'disabled' : ''}>
                                        <span class="material-icons-outlined text-sm">arrow_upward</span>
                                    </button>
                                    <button class="move-btn-down p-1 hover:bg-white rounded text-slate-400 hover:text-slate-700 disabled:opacity-0 transition-all" data-day="${dayIndex}" data-idx="${eventIndex}" ${eventIndex === day.events.length - 1 ? 'disabled' : ''}>
                                        <span class="material-icons-outlined text-sm">arrow_downward</span>
                                    </button>
                                    <button class="delete-btn p-1 hover:bg-red-50 rounded text-slate-300 hover:text-red-500 ml-1 transition-all" data-day="${dayIndex}" data-idx="${eventIndex}">
                                        <span class="material-icons-outlined text-sm">close</span>
                                    </button>
                                </div>
                            </div>
                            <h4 class="text-base font-bold text-slate-900 mb-1">${event.locationName}</h4>
                            <p class="text-sm text-slate-600 leading-relaxed">${event.description}</p>
                            
                            <div class="flex flex-wrap gap-2 mt-3 pt-3 border-t border-slate-100/50">
                                    ${isFood ? `
                                    <a href="https://www.zomato.com/search?q=${encodedLoc}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 bg-[#cb202d] text-white text-[10px] font-bold rounded hover:bg-[#b01b27] transition-colors shadow-sm">
                                    <span class="material-icons-outlined text-[12px]">restaurant</span> Zomato
                                    </a>
                                    <a href="https://www.swiggy.com/search?query=${encodedLoc}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 bg-[#fc8019] text-white text-[10px] font-bold rounded hover:bg-[#e47316] transition-colors shadow-sm">
                                    <span class="material-icons-outlined text-[12px]">delivery_dining</span> Swiggy
                                    </a>` : ''}
                                    <a href="https://m.uber.com/ul/?action=setPickup&client_id=uber&pickup=my_location&dropoff[formatted_address]=${encodedLoc}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 bg-slate-100 text-slate-700 border border-slate-200 text-[10px] font-bold rounded hover:bg-slate-200 transition-colors">
                                    <span class="material-icons-outlined text-[12px]">local_taxi</span> Uber
                                    </a>
                                    <a href="https://www.rapido.bike/" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 bg-[#f9c935] text-slate-900 border border-yellow-400 text-[10px] font-bold rounded hover:bg-[#eebf2f] transition-colors">
                                    <span class="material-icons-outlined text-[12px]">two_wheeler</span> Rapido
                                    </a>
                                    <a href="https://www.google.com/maps/search/?api=1&query=${mapsLoc}" target="_blank" class="inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 border border-blue-100 text-[10px] font-bold rounded hover:bg-blue-100 transition-colors">
                                    <span class="material-icons-outlined text-[12px]">map</span> Map
                                    </a>
                            </div>
                        </div>
                    </div>`; 
                }); 
                contentHTML += `</div>`; 
                dayContainer.innerHTML = contentHTML; 
                itineraryContentContainer.appendChild(dayContainer); 
            });
            lucide.createIcons();
        }

        // --- HELPER UI FUNCTIONS ---
        function showSection(section) {
            [elements.heroSection, elements.planningSection, elements.loadingSection, elements.itinerarySection].forEach(s => s.classList.add('hidden'));
            document.getElementById('errorMessage').classList.remove('show');
            section.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-4');
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-4'); }, 3500);
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeModal(modal) {
            if (!modal) return;
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function handleItineraryClick(e) {
            const upBtn = e.target.closest('.move-btn-up');
            const downBtn = e.target.closest('.move-btn-down');
            const deleteBtn = e.target.closest('.delete-btn');

            if (upBtn && !upBtn.disabled) moveEvent(parseInt(upBtn.dataset.day), parseInt(upBtn.dataset.idx), -1);
            if (downBtn && !downBtn.disabled) moveEvent(parseInt(downBtn.dataset.day), parseInt(downBtn.dataset.idx), 1);
            if (deleteBtn) deleteEvent(parseInt(deleteBtn.dataset.day), parseInt(deleteBtn.dataset.idx));
        }

        function moveEvent(dayIdx, eventIdx, direction) {
            if (!currentItineraryData) return;
            const events = currentItineraryData.days[dayIdx].events;
            const newIdx = eventIdx + direction;
            if (newIdx >= 0 && newIdx < events.length) {
                [events[eventIdx], events[newIdx]] = [events[newIdx], events[eventIdx]];
                renderItinerary(currentItineraryData, currentItineraryData.details);
            }
        }

        function deleteEvent(dayIdx, eventIdx) {
            if (!currentItineraryData) return;
            currentItineraryData.days[dayIdx].events.splice(eventIdx, 1);
            renderItinerary(currentItineraryData, currentItineraryData.details);
        }

        // --- EVENT LISTENERS ---
        document.getElementById('startPlanningBtn').addEventListener('click', () => {
            if (currentUser) { showSection(elements.planningSection); } 
            else { showToast("Please sign in to plan."); handleLogin(); }
        });
        
        document.getElementById('generateBtn').addEventListener('click', startGeneration);
        document.getElementById('startOverBtn').addEventListener('click', () => showSection(elements.heroSection));
        document.getElementById('saveTripBtn').addEventListener('click', saveCurrentTrip);
        
        document.getElementById('itinerary-content-container').addEventListener('click', handleItineraryClick);

        elements.modalsContainer.addEventListener('click', (e) => {
            if(e.target.closest('.close-modal-btn') || e.target.matches('.modal-backdrop')) {
                closeModal(e.target.closest('.modal-backdrop'));
            }
        });
        
        window.onload = function() {
            lucide.createIcons();
        }
    </script>
</body>
</html>